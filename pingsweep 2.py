import subprocess
import ipaddress
import os
import sys


def pingSweep(network):
    onlineHosts = []
    #check if network is valid

    try:
        ipNetwork = ipaddress.IPv4Network(network, strict=False)
    except ipaddress.AddressValueError:
        try:
            ipNetwork = ipaddress.IPv6Network(network, strict=False)
        except ipaddress.AddressValueError:
            print("Invalid network address")
            return []

    #Iterate through ip assets
    for ip in ipNetwork:
        print("IO: {}".format(ip))  #debug
        ipStr = "{}".format(ip)     #convert to string

        #IPv4 or IPv6?
        if isinstance(ip, ipaddress.IPv4Address):
            pingCmd = ['ping', '-c', '1', '-W', '1', ipStr]
        elif isinstance(ip, ipaddress.IPv6Address):
            pingCmd = ['ping6', '-c', '1', '-W', '1', ipStr]
        else:
            continue
        #capture output
        result = subprocess.run(pingCmd, text=True, capture_output=True)
        #check if host is reachable and has 64 bytes in the output
        if result.returncode == 0 and "64 bytes" in result.stdout:
            onlineHosts.append(ipStr)
    return onlineHosts

#this function is not used yet, need to update commands
def runNmapScan(onlineHosts):
    print("Running nmap scan...")
    #run nmap scan
    nmapCmd = ['nmap', '-T4', '-p', '1-65535'] + onlineHosts
    subprocess.run(nmapCmd)
    print("Nmap scan complete")


def runNessusScan(onlineHosts):
    print("Running Nessus scan...")
    #run nessus scan
    nessusCmd = ['nessus', 'scan', '-r', 'All', '-t'] + onlineHosts
    subprocess.run(nessusCmd)
    print("Nessus scan complete")


if __name__ == '__main__':

    file_path = input("Enter the path to the text file containing IP addresses: ")
    onlineHosts = []
    
    try:
        with open(file_path, 'r') as file:
            for line in file:
                line = line.strip()
                if line:
                    onlineHosts.extend(pingSweep(line))
        
        if onlineHosts:
            print("The following hosts are online: ")
            for host in onlineHosts:
                print(host)

        else:
            print("No hosts are online.")
    except FileNotFoundError:
        print("File not found")
        sys.exit(1)
